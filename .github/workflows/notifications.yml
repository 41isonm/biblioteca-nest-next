name: Notifications

on:
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    types:
      - completed
      - requested

jobs:
  notify:
    name: ðŸ“¢ Enviar NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion != 'skipped' }}
    
    steps:
      - name: Obter Status do Workflow
        id: workflow_status
        run: |
          echo "Workflow: ${{ github.event.workflow_run.name }}"
          echo "Status: ${{ github.event.workflow_run.conclusion }}"
          echo "URL: ${{ github.event.workflow_run.html_url }}"
          
          # Salva em outputs
          echo "workflow_name=${{ github.event.workflow_run.name }}" >> $GITHUB_OUTPUT
          echo "conclusion=${{ github.event.workflow_run.conclusion }}" >> $GITHUB_OUTPUT
          echo "html_url=${{ github.event.workflow_run.html_url }}" >> $GITHUB_OUTPUT

      - name: Notificar Slack
        if: always()
        uses: 8398a7/action-slack@v3
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: ${{ github.event.workflow_run.conclusion }}
          author_name: GitHub Actions
          fields: workflow,event,commit,message,ref
          mention: here
          if_mention: failure

 
     
      - name: Criar Issue no GitHub em caso de falha
        if: github.event.workflow_run.conclusion == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open'
            });
            
            // Verifica se jÃ¡ existe issue com mesmo tÃ­tulo
            const existingIssue = issues.find(issue => 
              issue.title.includes(`Pipeline Failure: ${context.workflow}`)
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ðŸš¨ Pipeline Failure: ${context.workflow}`,
                body: `A pipeline **${context.workflow}** falhou.\n\n**URL:** ${context.payload.workflow_run.html_url}\n**Branch:** ${context.payload.workflow_run.head_branch}\n**Commit:** ${context.payload.workflow_run.head_sha}`,
                labels: ['bug', 'pipeline-failure']
              });
            }